<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><meta name=author content=itkq><meta name=description content="モチベーション サービスメッシュのための Side-car proxy として有名な Envoy proxy (以下 Envoy) がある。Envoy は Observability や Resiliency など便利な機能の他に、Fault Injection 機能を持つ。この Fault injection は、システム全体の可用性を向上させるためのシステム間通信の障害のエミュレートに使われるものであり、これは一般に Chaos Engineering や Resiliency Testing と呼ばれる。
最近 Chaos Engineering に興味があったため、Envoy を使った簡単な Fault Injection を試すことにした。Envoy で Fault Injection をするためには Fault Injection filter を利用する。Fault Injection filter の設定を行えば、「ある upstream に対してリクエストするとき、ある確率で 503 を返す、または (同時に) ある確率でレスポンスを 1 秒遅らせる」といったことが可能である。Chaos Engineering の文脈で Fault Injection を行う場合は、どの程度・どの期間障害を起こすのか設定する必要があり、すなわち Fault Injection filter の設定を動的に変更する必要がある。Envoy には Runtime configuration という機能がある。あるファイルシステムツリーに設定値を書き、Envoy が watch する特定のシンボリックリンクをそのツリーに貼り直すと、Envoy が動的にその設定値を使うようになる、というものだ。Fault Injection filter で設定する値も Runtime configuration による設定が可能である。Runtime configuration 以外にも Listener discovery service (LDS) を使う手もありそうだったが、Listen している socket が変更される cons がありそうだったため今回は Runtime configuration だけ試した。"><meta name=google-site-verification content=AyWEWMfqdOijgoPW5yMy188xoQqY46L6pFXyd3Jizyc><meta property=og:title content="Envoy proxy と consul-template を使った Fault injection を試した"><meta property=og:description content="モチベーション サービスメッシュのための Side-car proxy として有名な Envoy proxy (以下 Envoy) がある。Envoy は Observability や Resiliency など便利な機能の他に、Fault Injection 機能を持つ。この Fault injection は、システム全体の可用性を向上させるためのシステム間通信の障害のエミュレートに使われるものであり、これは一般に Chaos Engineering や Resiliency Testing と呼ばれる。
最近 Chaos Engineering に興味があったため、Envoy を使った簡単な Fault Injection を試すことにした。Envoy で Fault Injection をするためには Fault Injection filter を利用する。Fault Injection filter の設定を行えば、「ある upstream に対してリクエストするとき、ある確率で 503 を返す、または (同時に) ある確率でレスポンスを 1 秒遅らせる」といったことが可能である。Chaos Engineering の文脈で Fault Injection を行う場合は、どの程度・どの期間障害を起こすのか設定する必要があり、すなわち Fault Injection filter の設定を動的に変更する必要がある。Envoy には Runtime configuration という機能がある。あるファイルシステムツリーに設定値を書き、Envoy が watch する特定のシンボリックリンクをそのツリーに貼り直すと、Envoy が動的にその設定値を使うようになる、というものだ。Fault Injection filter で設定する値も Runtime configuration による設定が可能である。Runtime configuration 以外にも Listener discovery service (LDS) を使う手もありそうだったが、Listen している socket が変更される cons がありそうだったため今回は Runtime configuration だけ試した。"><meta property=og:type content=article><meta property=og:url content=https://itkq.jp/blog/2018/09/12/envoy-consul-template-failure-injection-sample/><meta property=article:published_time content=2018-09-12T23:49:16&#43;09:00><meta property=article:modified_time content=2018-09-12T23:49:16&#43;09:00><title>Envoy proxy と consul-template を使った Fault injection を試した</title><link rel=canonical href=https://itkq.jp/blog/2018/09/12/envoy-consul-template-failure-injection-sample/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/github.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500"><link rel=stylesheet href="https://itkq.jp/css/reset.css?t=2020-06-20%2014%3a17%3a11.032230604%20%2b0900%20JST%20m%3d%2b0.065584990"><link rel=stylesheet href="https://itkq.jp/css/pygments.css?t=2020-06-20%2014%3a17%3a11.032230604%20%2b0900%20JST%20m%3d%2b0.065584990"><link rel=stylesheet href="https://itkq.jp/css/main.css?t=2020-06-20%2014%3a17%3a11.032230604%20%2b0900%20JST%20m%3d%2b0.065584990"><link rel=stylesheet href="https://itkq.jp/css/override.css?t=2020-06-20%2014%3a17%3a11.032230604%20%2b0900%20JST%20m%3d%2b0.065584990"><link rel="shortcut icon" href=https://itkq.jp/img/leaf.ico></head><body lang=ja><section class=header><div class=container><a href=https://itkq.jp/><img class=avatar src=https://itkq.jp/img/profile.png srcset="https://itkq.jp/img/profile.png 1x"></a><div class=content><a href=https://itkq.jp/><div class=name>itkq</div></a><nav><ul><li class=nav-blog><a href=https://itkq.jp/blog/><span>Blog</span></a></li><li class=nav-about><a href=https://itkq.jp/about/><span>About</span></a></li></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=https://github.com/itkq target=_blank rel=noopener><img class=icon src=https://itkq.jp/img/github.svg alt=github></a>
<a href=https://twitter.com/itkq target=_blank rel=noopener><img class=icon src=https://itkq.jp/img/twitter.svg alt=twitter></a>
<a href=//linkedin.com/in/takuya-kosugiyama-107402195/ target=_blank rel=noopener><img class=icon src=https://itkq.jp/img/linkedin.svg alt=linkedin></a>
<a href=mailto:re@itkq.jp><img class=icon src=https://itkq.jp/img/email.svg alt=email></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Envoy proxy と consul-template を使った Fault injection を試した</div><div class=initials><a href=https://itkq.jp/>ad</a></div></div><div class=meta><div class=date title="Wed Sep 12 2018 23:49:16 JST">Sep 12, 2018</div></div></div><div class=markdown><h2 id=モチベーション>モチベーション</h2><p>サービスメッシュのための Side-car proxy として有名な <a href=https://www.envoyproxy.io/>Envoy proxy</a> (以下 Envoy) がある。Envoy は Observability や Resiliency など便利な機能の他に、Fault Injection 機能を持つ。この Fault injection は、システム全体の可用性を向上させるためのシステム間通信の障害のエミュレートに使われるものであり、これは一般に Chaos Engineering や Resiliency Testing と呼ばれる。</p><p>最近 Chaos Engineering に興味があったため、Envoy を使った簡単な Fault Injection を試すことにした。Envoy で Fault Injection をするためには <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v1/http_filters/fault_filter#config-http-filters-fault-injection-v1>Fault Injection filter</a> を利用する。Fault Injection filter の設定を行えば、「ある upstream に対してリクエストするとき、ある確率で 503 を返す、または (同時に) ある確率でレスポンスを 1 秒遅らせる」といったことが可能である。Chaos Engineering の文脈で Fault Injection を行う場合は、どの程度・どの期間障害を起こすのか設定する必要があり、すなわち Fault Injection filter の設定を動的に変更する必要がある。Envoy には <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/runtime#arch-overview-runtime>Runtime configuration</a> という機能がある。あるファイルシステムツリーに設定値を書き、Envoy が watch する特定のシンボリックリンクをそのツリーに貼り直すと、Envoy が動的にその設定値を使うようになる、というものだ。Fault Injection filter で設定する値も Runtime configuration による設定が可能である。Runtime configuration 以外にも <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/lds>Listener discovery service</a> (LDS) を使う手もありそうだったが、Listen している socket が変更される cons がありそうだったため今回は Runtime configuration だけ試した。</p><p>以上より、Fault Injection filter の設定値を put すると、Runtime configuration を使って動的に設定値を変更する API を用意すれば、目的の Fault Injection が達成できそうだ。ファイルシステムに書き込む必要があるため、今回は Consul KV Store と consul-template を使ってやってみる。</p><h2 id=実装>実装</h2><p><a href=https://github.com/itkq/envoy-consul-template-failure-injection-sample>GitHub リポジトリ</a>に docker-compose で動くサンプルを用意した。サンプルでは front と backend の 2 つのサービスがあり、front は backend に依存している。front は Envoy 経由で backend に HTTP リクエストする。</p><p>consul-template が書き込むディレクトリを Envoy も見ている必要があるため、Docker volume の機能を使いホストのディレクトリを mount している。consul-template は watch している key tree が変更されると、値を所定のパスに書き込む動きをする。</p><h2 id=実験>実験</h2><p><code>APP_ID=front docker-compose up --build</code> で Consul Server, Consul Agent を含むコンテナ郡を起動する。この実験では Fault Injection の機能のうち、リクエストに対しサーバーエラーを返す abort を対象とする。以下のように Consul KV に設定値を書き込む。</p><pre><code>$ export APP_ID=front
$ consul kv put &quot;envoy_override/$APP_ID/fault/http/abort/abort_percent&quot; 50
$ consul kv put &quot;envoy_override/$APP_ID/fault/http/abort/http_status&quot; 503
</code></pre><p>続いて、front に対してリクエストを投げ続ける。</p><pre><code>$ while :; do curl -sLI localhost:3000/backend -o /dev/null -w '%{http_code}\n'; sleep 1; done
200
200
200
200
200
500
500
500
200
500
500
500
500
500
200
500
200
200
200
</code></pre><p>500 を返したときの front のログは以下のようになっている。front は backend から 503 が返ってきたため例外を起こし結果的に 500 を返しており、設定の通り Fault Injection できていることが分かる。</p><pre><code>front_1                    | 2018-09-12 13:49:09 - Net::HTTPFatalError - 503 &quot;Service Unavailable&quot;:
front_1                    |    /usr/lib/ruby/2.5.0/net/http/response.rb:122:in `error!'
front_1                    |    /usr/lib/ruby/2.5.0/net/http/response.rb:131:in `value'
(snip)
</code></pre><p>以下のように <code>abort_percent</code> を 0 にすると、以降全て 200 が返ってくることを確認した。</p><pre><code>$ consul kv put &quot;envoy_override/$APP_ID/fault/http/abort/abort_percent&quot; 0
</code></pre><h2 id=まとめ>まとめ</h2><p>簡単なサンプルではあるが、Envoy と consul-template を連携させて Docker コンテナ間通信に対して動的に Fault Injection することができた。Envoy のドキュメントは充実しているが、Fault Injection に関しては公式以外の記事がほとんど見当たらなかったため、試してみた記事を書いた次第。</p><br><p class=back-to-posts><a href=https://itkq.jp/blog/>Back to posts</a></p></div><br><div class=disqus><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"itkq-jp"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-71205730-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js></script><script type=text/javascript>hljs.initHighlightingOnLoad();</script></body></html>