<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="itkq"><meta name=description content="元々は NeoVim を導入しようとしていた．その一環で，dotfiles を良い感じにしようとしていて，mitamae によるプロビジョニング設定の k0kubun/dotfiles から fork したものを整理していた．NeoBundle の NeoVim 対応版である dein.vim を導入する際，curl が必要だった．itamae の Resource ドキュメントを読むと，http_request というリソースがあった．これ使えば Docker の ADDコマンド的なことできるのかなと思ったけど詳細が書いてなくて，そういえば itamae 自体どうやって動いてるんだと気になったので読むことにした．
itamae-kitchen/itamae/
Code reading bin/itamae Itamae::CLI.start を呼ぶ．
lib/itamae/cli.rb Itamae::CLI は CLI gem Thor を継承している． 実行環境 (backend_type) は3つあり，local, ssh, docker である．必要としていて，かつ他より単純そうな local を続けて読む．
def local(*recipe_files) if recipe_files.empty? raise &#34;Please specify recipe files.&#34; end run(recipe_files, :local, options) end def run(recipe_files, backend_type, options) runner = Runner.run(recipe_files, backend_type, options) if options[:detailed_exitcode] && runner."><meta name=google-site-verification content="AyWEWMfqdOijgoPW5yMy188xoQqY46L6pFXyd3Jizyc"><meta property="og:title" content="itamae コードリーディング"><meta property="og:description" content="元々は NeoVim を導入しようとしていた．その一環で，dotfiles を良い感じにしようとしていて，mitamae によるプロビジョニング設定の k0kubun/dotfiles から fork したものを整理していた．NeoBundle の NeoVim 対応版である dein.vim を導入する際，curl が必要だった．itamae の Resource ドキュメントを読むと，http_request というリソースがあった．これ使えば Docker の ADDコマンド的なことできるのかなと思ったけど詳細が書いてなくて，そういえば itamae 自体どうやって動いてるんだと気になったので読むことにした．
itamae-kitchen/itamae/
Code reading bin/itamae Itamae::CLI.start を呼ぶ．
lib/itamae/cli.rb Itamae::CLI は CLI gem Thor を継承している． 実行環境 (backend_type) は3つあり，local, ssh, docker である．必要としていて，かつ他より単純そうな local を続けて読む．
def local(*recipe_files) if recipe_files.empty? raise &#34;Please specify recipe files.&#34; end run(recipe_files, :local, options) end def run(recipe_files, backend_type, options) runner = Runner.run(recipe_files, backend_type, options) if options[:detailed_exitcode] && runner."><meta property="og:type" content="article"><meta property="og:url" content="https://itkq.jp/blog/2017/03/19/itamae-reading/"><meta property="article:published_time" content="2017-03-19T19:25:53+09:00"><meta property="article:modified_time" content="2017-03-19T19:25:53+09:00"><title>itamae コードリーディング</title><link rel=canonical href=https://itkq.jp/blog/2017/03/19/itamae-reading/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/github.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500"><link rel=stylesheet href="https://itkq.jp/css/reset.css?t=2020-06-20%2016%3a32%3a17.747336376%20%2b0900%20JST%20m%3d%2b0.111785228"><link rel=stylesheet href="https://itkq.jp/css/pygments.css?t=2020-06-20%2016%3a32%3a17.747336376%20%2b0900%20JST%20m%3d%2b0.111785228"><link rel=stylesheet href="https://itkq.jp/css/main.css?t=2020-06-20%2016%3a32%3a17.747336376%20%2b0900%20JST%20m%3d%2b0.111785228"><link rel=stylesheet href="https://itkq.jp/css/override.css?t=2020-06-20%2016%3a32%3a17.747336376%20%2b0900%20JST%20m%3d%2b0.111785228"><link rel="shortcut icon" href=https://itkq.jp/img/leaf.ico></head><body lang=ja><section class=header><div class=container><a href=https://itkq.jp/><img class=avatar src=https://itkq.jp/img/profile.png srcset="https://itkq.jp/img/profile.png 1x"></a><div class=content><a href=https://itkq.jp/><div class=name>itkq</div></a><nav><ul><li class=nav-blog><a href=https://itkq.jp/blog/><span>Blog</span></a></li><li class=nav-about><a href=https://itkq.jp/about/><span>About</span></a></li></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=https://github.com/itkq target=_blank rel=noopener><img class=icon src=https://itkq.jp/img/github.svg alt=github></a>
<a href=https://twitter.com/itkq target=_blank rel=noopener><img class=icon src=https://itkq.jp/img/twitter.svg alt=twitter></a>
<a href=//linkedin.com/in/takuya-kosugiyama-107402195/ target=_blank rel=noopener><img class=icon src=https://itkq.jp/img/linkedin.svg alt=linkedin></a>
<a href=mailto:re@itkq.jp><img class=icon src=https://itkq.jp/img/email.svg alt=email></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>itamae コードリーディング</div><div class=initials><a href=https://itkq.jp/>ad</a></div></div><div class=meta><div class=date title="Sun Mar 19 2017 19:25:53 JST">Mar 19, 2017</div></div></div><div class=markdown><p>元々は NeoVim を導入しようとしていた．その一環で，dotfiles を良い感じにしようとしていて，mitamae によるプロビジョニング設定の <a href=https://github.com/k0kubun/dotfiles>k0kubun/dotfiles</a> から fork したものを整理していた．NeoBundle の NeoVim 対応版である dein.vim を導入する際，curl が必要だった．itamae の Resource ドキュメントを読むと，<code>http_request</code> というリソースがあった．これ使えば Docker の ADDコマンド的なことできるのかなと思ったけど詳細が書いてなくて，そういえば itamae 自体どうやって動いてるんだと気になったので読むことにした．</p><p><a href=https://github.com/itamae-kitchen/itamae/>itamae-kitchen/itamae/</a></p><h1 id=code-reading>Code reading</h1><h2 id=binitamae>bin/itamae</h2><p><code>Itamae::CLI.start</code> を呼ぶ．</p><h2 id=libitamaeclirb>lib/itamae/cli.rb</h2><p><code>Itamae::CLI</code> は CLI gem <code>Thor</code> を継承している．
実行環境 (backend_type) は3つあり，local, ssh, docker である．必要としていて，かつ他より単純そうな local を続けて読む．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=k>def</span> <span class=nf>local</span><span class=p>(</span><span class=o>*</span><span class=n>recipe_files</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>recipe_files</span><span class=o>.</span><span class=n>empty?</span>
      <span class=k>raise</span> <span class=s2>&#34;Please specify recipe files.&#34;</span>
    <span class=k>end</span>

    <span class=n>run</span><span class=p>(</span><span class=n>recipe_files</span><span class=p>,</span> <span class=ss>:local</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
  <span class=k>end</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>recipe_files</span><span class=p>,</span> <span class=n>backend_type</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
    <span class=n>runner</span> <span class=o>=</span> <span class=no>Runner</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>recipe_files</span><span class=p>,</span> <span class=n>backend_type</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>options</span><span class=o>[</span><span class=ss>:detailed_exitcode</span><span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=n>runner</span><span class=o>.</span><span class=n>diff?</span>
      <span class=nb>exit</span> <span class=mi>2</span>
    <span class=k>end</span>
  <span class=k>end</span>
</code></pre></div><h2 id=libitamaerunnerrb-1>lib/itamae/runner.rb (1)</h2><p>抽象実行環境のクラス <code>Itamae::Backend</code> を new している．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=k>class</span> <span class=nc>Runner</span>
  <span class=k>class</span> <span class=o>&lt;&lt;</span> <span class=nb>self</span>
    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>recipe_files</span><span class=p>,</span> <span class=n>backend_type</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
      <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span> <span class=s2>&#34;Starting Itamae...&#34;</span>
      
      <span class=n>backend</span> <span class=o>=</span> <span class=no>Backend</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>backend_type</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
      <span class=n>runner</span> <span class=o>=</span> <span class=nb>self</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>backend</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
      <span class=n>runner</span><span class=o>.</span><span class=n>load_recipes</span><span class=p>(</span><span class=n>recipe_files</span><span class=p>)</span>
      <span class=n>runner</span><span class=o>.</span><span class=n>run</span>

      <span class=n>runner</span>
    <span class=k>end</span>
  <span class=k>end</span>
</code></pre></div><h2 id=libitamaebackendrb>lib/itamae/backend.rb</h2><p>itamae は serverspec のための抽象フレームワークである <a href=https://github.com/mizzy/specinfra>mizzy/specinfra</a> に依存している．local の場合，基本的には <code>/bin/sh</code> を起動して良い感じにコマンド実行して出力を
得る動作だと思う．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=k>def</span> <span class=nf>create_specinfra_backend</span>
    <span class=no>Specinfra</span><span class=o>::</span><span class=no>Backend</span><span class=o>::</span><span class=no>Exec</span><span class=o>.</span><span class=n>new</span><span class=p>(</span>
      <span class=ss>shell</span><span class=p>:</span> <span class=vi>@options</span><span class=o>[</span><span class=ss>:shell</span><span class=o>]</span><span class=p>,</span>
    <span class=p>)</span>
  <span class=k>end</span>
</code></pre></div><h2 id=libitamaerunnerrb-2>lib/itamae/runner.rb (2)</h2><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>backend</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
    <span class=vi>@backend</span> <span class=o>=</span> <span class=n>backend</span>
    <span class=vi>@options</span> <span class=o>=</span> <span class=n>options</span>

    <span class=n>prepare_handler</span>

    <span class=vi>@node</span> <span class=o>=</span> <span class=n>create_node</span>
    <span class=vi>@tmpdir</span> <span class=o>=</span> <span class=s2>&#34;/tmp/itamae_tmp&#34;</span>
    <span class=vi>@children</span> <span class=o>=</span> <span class=no>RecipeChildren</span><span class=o>.</span><span class=n>new</span>
    <span class=vi>@diff</span> <span class=o>=</span> <span class=kp>false</span>
    
    <span class=vi>@backend</span><span class=o>.</span><span class=n>run_command</span><span class=p>(</span><span class=o>[</span><span class=s2>&#34;mkdir&#34;</span><span class=p>,</span> <span class=s2>&#34;-p&#34;</span><span class=p>,</span> <span class=vi>@tmpdir</span><span class=o>]</span><span class=p>)</span>
    <span class=vi>@backend</span><span class=o>.</span><span class=n>run_command</span><span class=p>(</span><span class=o>[</span><span class=s2>&#34;chmod&#34;</span><span class=p>,</span> <span class=s2>&#34;777&#34;</span><span class=p>,</span> <span class=vi>@tmpdir</span><span class=o>]</span><span class=p>)</span>
  <span class=k>end</span>
</code></pre></div><p><code>/tmp/itamae_tmp</code> を <code>777</code> で作成する．その後レシピのロード．
<code>path</code> が名前空間なら gem, そうでなければ ファイルパスを <code>Itamae::Recipe.new</code> に渡す．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=k>def</span> <span class=nf>load_recipes</span><span class=p>(</span><span class=n>paths</span><span class=p>)</span>
    <span class=n>paths</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>path</span><span class=o>|</span>
      <span class=n>expanded_path</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>expand_path</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
      <span class=k>if</span> <span class=n>path</span><span class=o>.</span><span class=n>include?</span><span class=p>(</span><span class=s1>&#39;::&#39;</span><span class=p>)</span>
        <span class=n>gem_path</span> <span class=o>=</span> <span class=no>Recipe</span><span class=o>.</span><span class=n>find_recipe_in_gem</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
        <span class=n>expanded_path</span> <span class=o>=</span> <span class=n>gem_path</span> <span class=k>if</span> <span class=n>gem_path</span>
      <span class=k>end</span>

      <span class=n>recipe</span> <span class=o>=</span> <span class=no>Recipe</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=nb>self</span><span class=p>,</span> <span class=n>expanded_path</span><span class=p>)</span>
      <span class=n>children</span> <span class=o>&lt;&lt;</span> <span class=n>recipe</span>
      <span class=n>recipe</span><span class=o>.</span><span class=n>load</span>
    <span class=k>end</span>
  <span class=k>end</span>
</code></pre></div><h2 id=libitamaereciperb-1>lib/itamae/recipe.rb (1)</h2><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby> <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>runner</span><span class=p>,</span> <span class=n>path</span><span class=p>)</span>
    <span class=vi>@runner</span> <span class=o>=</span> <span class=n>runner</span>
    <span class=vi>@path</span> <span class=o>=</span> <span class=n>path</span>
    <span class=vi>@delayed_notifications</span> <span class=o>=</span> <span class=o>[]</span>
    <span class=vi>@children</span> <span class=o>=</span> <span class=no>RecipeChildren</span><span class=o>.</span><span class=n>new</span>
  <span class=k>end</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=k>def</span> <span class=nf>load</span><span class=p>(</span><span class=n>vars</span> <span class=o>=</span> <span class=p>{})</span>
    <span class=n>context</span> <span class=o>=</span> <span class=no>EvalContext</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=nb>self</span><span class=p>,</span> <span class=n>vars</span><span class=p>)</span>
    <span class=n>context</span><span class=o>.</span><span class=n>instance_eval</span><span class=p>(</span><span class=no>File</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>path</span><span class=p>),</span> <span class=n>path</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
  <span class=k>end</span>
</code></pre></div><p><code>EvalContext</code> が登場する．<code>BasicObject#instance_eval</code> は，Rubyコードの文字列と，レシーバのコンテキストを含むブロックを評価する．このメソッドにより，レシピファイルの内容を1行目から評価していく．</p><h3 id=evalcontext>EvalContext</h3><p><code>Basic#respond_to_missing?</code> は <code>BasicObject#method_missing</code> で反応するメソッドを定義．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>    <span class=k>class</span> <span class=nc>EvalContext</span>
      <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>recipe</span><span class=p>,</span> <span class=n>vars</span><span class=p>)</span>
        <span class=vi>@recipe</span> <span class=o>=</span> <span class=n>recipe</span>

        <span class=n>vars</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>k</span><span class=p>,</span> <span class=n>v</span><span class=o>|</span>
          <span class=n>define_singleton_method</span><span class=p>(</span><span class=n>k</span><span class=p>)</span> <span class=p>{</span> <span class=n>v</span> <span class=p>}</span>
        <span class=k>end</span>
      <span class=k>end</span>

      <span class=k>def</span> <span class=nf>respond_to_missing?</span><span class=p>(</span><span class=nb>method</span><span class=p>,</span> <span class=n>include_private</span> <span class=o>=</span> <span class=kp>false</span><span class=p>)</span>
        <span class=no>Resource</span><span class=o>.</span><span class=n>get_resource_class</span><span class=p>(</span><span class=nb>method</span><span class=p>)</span>
        <span class=kp>true</span>
      <span class=k>rescue</span> <span class=no>NameError</span>
        <span class=kp>false</span>
      <span class=k>end</span>
</code></pre></div><p><code>[resource] do ... end</code> のための <code>BasicObject#method_missing</code>．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>      <span class=k>def</span> <span class=nf>method_missing</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>block</span><span class=p>)</span>
        <span class=k>super</span> <span class=k>unless</span> <span class=n>args</span><span class=o>.</span><span class=n>size</span> <span class=o>==</span> <span class=mi>2</span>

        <span class=nb>method</span><span class=p>,</span> <span class=nb>name</span> <span class=o>=</span> <span class=n>args</span>
        <span class=k>begin</span>
          <span class=n>klass</span> <span class=o>=</span> <span class=no>Resource</span><span class=o>.</span><span class=n>get_resource_class</span><span class=p>(</span><span class=nb>method</span><span class=p>)</span>
        <span class=k>rescue</span> <span class=no>NameError</span>
          <span class=k>super</span>
        <span class=k>end</span>

        <span class=n>resource</span> <span class=o>=</span> <span class=n>klass</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=vi>@recipe</span><span class=p>,</span> <span class=nb>name</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>block</span><span class=p>)</span>
        <span class=vi>@recipe</span><span class=o>.</span><span class=n>children</span> <span class=o>&lt;&lt;</span> <span class=n>resource</span>
      <span class=k>end</span>
</code></pre></div><p>なんで <code>args.size == 2</code> なのかと思ったけどリファレンスによると</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=k>def</span> <span class=nf>method_missing</span><span class=p>(</span><span class=n>method_name</span> <span class=o>[</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span> <span class=o>[</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>block</span><span class=o>]]</span><span class=p>)</span>
</code></pre></div><p>で method_name も含まれていたからだった．ちょっとわかりづらかった．
続いて <code>Itamae::Resource#get_resource_class</code> が呼ばれる．</p><h2 id=libitamaeresourcerb>lib/itamae/resource.rb</h2><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=k>module</span> <span class=nn>Resource</span>
    <span class=k>class</span> <span class=o>&lt;&lt;</span> <span class=nb>self</span>
      <span class=k>def</span> <span class=nf>to_camel_case</span><span class=p>(</span><span class=n>str</span><span class=p>)</span>
        <span class=n>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;_&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>map</span> <span class=p>{</span><span class=o>|</span><span class=n>part</span><span class=o>|</span> <span class=n>part</span><span class=o>.</span><span class=n>capitalize</span><span class=p>}</span><span class=o>.</span><span class=n>join</span>
      <span class=k>end</span>

      <span class=k>def</span> <span class=nf>get_resource_class</span><span class=p>(</span><span class=nb>method</span><span class=p>)</span>
        <span class=k>begin</span>
          <span class=nb>self</span><span class=o>.</span><span class=n>const_get</span><span class=p>(</span><span class=n>to_camel_case</span><span class=p>(</span><span class=nb>method</span><span class=o>.</span><span class=n>to_s</span><span class=p>))</span>
        <span class=k>rescue</span> <span class=no>NameError</span>
          <span class=k>begin</span>
            <span class=o>::</span><span class=no>Itamae</span><span class=o>::</span><span class=no>Plugin</span><span class=o>::</span><span class=no>Resource</span><span class=o>.</span><span class=n>const_get</span><span class=p>(</span><span class=n>to_camel_case</span><span class=p>(</span><span class=nb>method</span><span class=o>.</span><span class=n>to_s</span><span class=p>))</span>
          <span class=k>rescue</span> <span class=no>NameError</span>
            <span class=n>autoload_plugin_resource</span><span class=p>(</span><span class=nb>method</span><span class=p>)</span>
          <span class=k>end</span>
        <span class=k>end</span>
      <span class=k>end</span>
</code></pre></div><p><code>Module#const_get</code> は定数の値を取り出す．メソッドを文字列化してCamelケースに変換してアクセスする．</p><h2 id=libitamaereciperb-2>lib/itamae/recipe.rb (2)</h2><p>取得した <code>Itamae::Resource::</code> 以下のクラスに，ブロックを渡して new する．
インスタンス変数 <code>@children</code> (<code>RecipeChildren</code>) に突っ込んでいく．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>        <span class=n>resource</span> <span class=o>=</span> <span class=n>klass</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=vi>@recipe</span><span class=p>,</span> <span class=nb>name</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>block</span><span class=p>)</span>
        <span class=vi>@recipe</span><span class=o>.</span><span class=n>children</span> <span class=o>&lt;&lt;</span> <span class=n>resource</span>
</code></pre></div><h2 id=libitamaerecipe_chilrenrb-1>lib/itamae/recipe_chilren.rb (1)</h2><p>当然ながら <code>Array</code> を継承している．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=k>module</span> <span class=nn>Itamae</span>
  <span class=k>class</span> <span class=nc>RecipeChildren</span> <span class=o>&lt;</span> <span class=nb>Array</span>
</code></pre></div><h2 id=libitamaerunnerrb-3>lib/itamae/runner.rb (3)</h2><p>レシピをロードした．続いて実行．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=k>class</span> <span class=nc>Runner</span>
  <span class=k>class</span> <span class=o>&lt;&lt;</span> <span class=nb>self</span>
    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>recipe_files</span><span class=p>,</span> <span class=n>backend_type</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
      <span class=o>...</span>
      <span class=n>runner</span><span class=o>.</span><span class=n>run</span>

      <span class=n>runner</span>
    <span class=k>end</span>
  <span class=k>end</span>
    
  <span class=k>def</span> <span class=nf>run</span>
    <span class=k>if</span> <span class=n>recipe_graph_file</span> <span class=o>=</span> <span class=n>options</span><span class=o>[</span><span class=ss>:recipe_graph</span><span class=o>]</span>
      <span class=n>save_dependency_graph</span><span class=p>(</span><span class=n>recipe_graph_file</span><span class=p>)</span>
    <span class=k>end</span>

    <span class=n>children</span><span class=o>.</span><span class=n>run</span>
    <span class=vi>@backend</span><span class=o>.</span><span class=n>finalize</span>

    <span class=k>if</span> <span class=n>profile</span> <span class=o>=</span> <span class=n>options</span><span class=o>[</span><span class=ss>:profile</span><span class=o>]</span>
      <span class=n>save_profile</span><span class=p>(</span><span class=n>profile</span><span class=p>)</span>
    <span class=k>end</span>
  <span class=k>end</span>
</code></pre></div><h2 id=libitamaerecipe_chilrenrb-2>lib/itamae/recipe_chilren.rb (2)</h2><p>各リソースについて実行．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=k>class</span> <span class=nc>RecipeChildren</span>
    <span class=k>def</span> <span class=nf>run</span>
      <span class=nb>self</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>resource</span><span class=o>|</span>
        <span class=n>resource</span><span class=o>.</span><span class=n>run</span>
      <span class=k>end</span>
    <span class=k>end</span>
</code></pre></div><h2 id=libitamaeresourcebaserb>lib/itamae/resource/base.rb</h2><p>リソースは <code>Itamae::Resource::Base</code> を継承して実装されている．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=k>module</span> <span class=nn>Itamae</span>
  <span class=k>module</span> <span class=nn>Resource</span>
    <span class=k>class</span> <span class=nc>Base</span>
      <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>recipe</span><span class=p>,</span> <span class=n>resource_name</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>block</span><span class=p>)</span>
        <span class=n>clear_current_attributes</span>
        <span class=vi>@recipe</span> <span class=o>=</span> <span class=n>recipe</span>
        <span class=vi>@resource_name</span> <span class=o>=</span> <span class=n>resource_name</span>
        <span class=vi>@updated</span> <span class=o>=</span> <span class=kp>false</span>

        <span class=no>EvalContext</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=nb>self</span><span class=p>)</span><span class=o>.</span><span class=n>tap</span> <span class=k>do</span> <span class=o>|</span><span class=n>context</span><span class=o>|</span>
          <span class=n>context</span><span class=o>.</span><span class=n>instance_eval</span><span class=p>(</span><span class=o>&amp;</span><span class=n>block</span><span class=p>)</span> <span class=k>if</span> <span class=n>block</span>
          <span class=vi>@attributes</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>attributes</span>
          <span class=vi>@notifications</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>notifications</span>
          <span class=vi>@subscriptions</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>subscriptions</span>
          <span class=vi>@only_if_command</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>only_if_command</span>
          <span class=vi>@not_if_command</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>not_if_command</span>
          <span class=vi>@verify_commands</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>verify_commands</span>
        <span class=k>end</span>

        <span class=n>process_attributes</span>
      <span class=k>end</span>
</code></pre></div><p>ここでも <code>EvalContext</code> が登場する．<code>Object#tap</code> は，レシーバ自身を返すメソッド．良い感じに簡潔に書きたい場合に使うっぽい．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>      <span class=k>class</span> <span class=nc>EvalContext</span>
        <span class=o>...</span>
        
        <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>resource</span><span class=p>)</span>
          <span class=vi>@resource</span> <span class=o>=</span> <span class=n>resource</span>

          <span class=vi>@attributes</span> <span class=o>=</span> <span class=no>Hashie</span><span class=o>::</span><span class=no>Mash</span><span class=o>.</span><span class=n>new</span>
          <span class=vi>@notifications</span> <span class=o>=</span> <span class=o>[]</span>
          <span class=vi>@subscriptions</span> <span class=o>=</span> <span class=o>[]</span>
          <span class=vi>@verify_commands</span> <span class=o>=</span> <span class=o>[]</span>
        <span class=k>end</span>

        <span class=k>def</span> <span class=nf>respond_to_missing?</span><span class=p>(</span><span class=nb>method</span><span class=p>,</span> <span class=n>include_private</span> <span class=o>=</span> <span class=kp>false</span><span class=p>)</span>
          <span class=vi>@resource</span><span class=o>.</span><span class=n>class</span><span class=o>.</span><span class=n>defined_attributes</span><span class=o>.</span><span class=n>has_key?</span><span class=p>(</span><span class=nb>method</span><span class=p>)</span> <span class=o>||</span> <span class=k>super</span>
        <span class=k>end</span>

        <span class=k>def</span> <span class=nf>method_missing</span><span class=p>(</span><span class=nb>method</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>block</span><span class=p>)</span>
          <span class=k>if</span> <span class=vi>@resource</span><span class=o>.</span><span class=n>class</span><span class=o>.</span><span class=n>defined_attributes</span><span class=o>[</span><span class=nb>method</span><span class=o>]</span>
            <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>size</span> <span class=o>==</span> <span class=mi>1</span>
              <span class=k>return</span> <span class=vi>@attributes</span><span class=o>[</span><span class=nb>method</span><span class=o>]</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=n>first</span>
            <span class=k>elsif</span> <span class=n>args</span><span class=o>.</span><span class=n>size</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nb>block_given?</span>
              <span class=k>return</span> <span class=vi>@attributes</span><span class=o>[</span><span class=nb>method</span><span class=o>]</span> <span class=o>=</span> <span class=n>block</span>
            <span class=k>elsif</span> <span class=n>args</span><span class=o>.</span><span class=n>size</span> <span class=o>==</span> <span class=mi>0</span>
              <span class=k>return</span> <span class=vi>@attributes</span><span class=o>[</span><span class=nb>method</span><span class=o>]</span>
            <span class=k>end</span>
          <span class=k>end</span>

          <span class=k>super</span>
        <span class=k>end</span>
</code></pre></div><p><code>Itamae::Resource::Base#defined_attributes</code> によって，attribute を定義できる．サブクラスからは呼ぶと上書きではなく追加で定義される．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>      <span class=k>class</span> <span class=o>&lt;&lt;</span> <span class=nb>self</span>
        <span class=kp>attr_reader</span> <span class=ss>:defined_attributes</span>

        <span class=k>def</span> <span class=nf>define_attribute</span><span class=p>(</span><span class=nb>name</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
          <span class=n>current</span> <span class=o>=</span> <span class=vi>@defined_attributes</span><span class=o>[</span><span class=nb>name</span><span class=o>.</span><span class=n>to_sym</span><span class=o>]</span> <span class=o>||</span> <span class=p>{}</span>
          <span class=vi>@defined_attributes</span><span class=o>[</span><span class=nb>name</span><span class=o>.</span><span class=n>to_sym</span><span class=o>]</span> <span class=o>=</span> <span class=n>current</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=n>options</span><span class=p>)</span>
        <span class=k>end</span>
      <span class=k>end</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>      <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>specific_action</span> <span class=o>=</span> <span class=kp>nil</span><span class=p>)</span>
        <span class=n>runner</span><span class=o>.</span><span class=n>handler</span><span class=o>.</span><span class=n>event</span><span class=p>(</span><span class=ss>:resource</span><span class=p>,</span> <span class=ss>resource_type</span><span class=p>:</span> <span class=n>resource_type</span><span class=p>,</span> <span class=ss>resource_name</span><span class=p>:</span> <span class=n>resource_name</span><span class=p>)</span> <span class=k>do</span>
          <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=n>resource_type</span><span class=si>}</span><span class=s2>[</span><span class=si>#{</span><span class=n>resource_name</span><span class=si>}</span><span class=s2>]&#34;</span>

          <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>with_indent_if</span><span class=p>(</span><span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug?</span><span class=p>)</span> <span class=k>do</span>
            <span class=k>if</span> <span class=n>do_not_run_because_of_only_if?</span>
              <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=n>resource_type</span><span class=si>}</span><span class=s2>[</span><span class=si>#{</span><span class=n>resource_name</span><span class=si>}</span><span class=s2>] Execution skipped because of only_if attribute&#34;</span>
              <span class=k>return</span>
            <span class=k>elsif</span> <span class=n>do_not_run_because_of_not_if?</span>
              <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=n>resource_type</span><span class=si>}</span><span class=s2>[</span><span class=si>#{</span><span class=n>resource_name</span><span class=si>}</span><span class=s2>] Execution skipped because of not_if attribute&#34;</span>
              <span class=k>return</span>
            <span class=k>end</span>

            <span class=o>[</span><span class=n>specific_action</span> <span class=o>||</span> <span class=n>attributes</span><span class=o>.</span><span class=n>action</span><span class=o>].</span><span class=n>flatten</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>action</span><span class=o>|</span>
              <span class=n>run_action</span><span class=p>(</span><span class=n>action</span><span class=p>)</span>
            <span class=k>end</span>

            <span class=n>verify</span> <span class=k>unless</span> <span class=n>runner</span><span class=o>.</span><span class=n>dry_run?</span>
            <span class=k>if</span> <span class=n>updated?</span>
              <span class=n>runner</span><span class=o>.</span><span class=n>diff_found!</span>
              <span class=n>notify</span>
              <span class=n>runner</span><span class=o>.</span><span class=n>handler</span><span class=o>.</span><span class=n>event</span><span class=p>(</span><span class=ss>:resource_updated</span><span class=p>)</span>
            <span class=k>end</span>
          <span class=k>end</span>

          <span class=vi>@updated</span> <span class=o>=</span> <span class=kp>false</span>
        <span class=k>end</span>
      <span class=k>rescue</span> <span class=no>Backend</span><span class=o>::</span><span class=no>CommandExecutionError</span>
        <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=n>resource_type</span><span class=si>}</span><span class=s2>[</span><span class=si>#{</span><span class=n>resource_name</span><span class=si>}</span><span class=s2>] Failed.&#34;</span>
        <span class=nb>exit</span> <span class=mi>2</span>
      <span class=k>end</span>
</code></pre></div><p><code>Itamae::Runner#handler</code> は <code>Itamae::HandlerProxy</code> のインスタンスである．
Proxy パターンであり，ロギングしているだけ．
実際の処理は <code>Itamae::Resource::Base#run_action</code> が行う．</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>      <span class=k>def</span> <span class=nf>run_action</span><span class=p>(</span><span class=n>action</span><span class=p>)</span>
        <span class=n>runner</span><span class=o>.</span><span class=n>handler</span><span class=o>.</span><span class=n>event</span><span class=p>(</span><span class=ss>:action</span><span class=p>,</span> <span class=ss>action</span><span class=p>:</span> <span class=n>action</span><span class=p>)</span> <span class=k>do</span>
          <span class=n>original_attributes</span> <span class=o>=</span> <span class=vi>@attributes</span> <span class=c1># preserve and restore later</span>
          <span class=vi>@current_action</span> <span class=o>=</span> <span class=n>action</span>

          <span class=n>clear_current_attributes</span>

          <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=n>resource_type</span><span class=si>}</span><span class=s2>[</span><span class=si>#{</span><span class=n>resource_name</span><span class=si>}</span><span class=s2>] action: </span><span class=si>#{</span><span class=n>action</span><span class=si>}</span><span class=s2>&#34;</span>

          <span class=k>return</span> <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=ss>:nothing</span>

          <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>with_indent_if</span><span class=p>(</span><span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug?</span><span class=p>)</span> <span class=k>do</span>
            <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span> <span class=s2>&#34;(in pre_action)&#34;</span>
            <span class=n>pre_action</span>

            <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span> <span class=s2>&#34;(in set_current_attributes)&#34;</span>
            <span class=n>set_current_attributes</span>

            <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span> <span class=s2>&#34;(in show_differences)&#34;</span>
            <span class=n>show_differences</span>

            <span class=n>method_name</span> <span class=o>=</span> <span class=s2>&#34;action_</span><span class=si>#{</span><span class=n>action</span><span class=si>}</span><span class=s2>&#34;</span>
            <span class=k>if</span> <span class=n>runner</span><span class=o>.</span><span class=n>dry_run?</span>
              <span class=k>unless</span> <span class=nb>respond_to?</span><span class=p>(</span><span class=n>method_name</span><span class=p>)</span>
                <span class=no>Itamae</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span> <span class=s2>&#34;action </span><span class=si>#{</span><span class=n>action</span><span class=o>.</span><span class=n>inspect</span><span class=si>}</span><span class=s2> is unavailable&#34;</span>
              <span class=k>end</span>
            <span class=k>else</span>
              <span class=n>args</span> <span class=o>=</span> <span class=o>[</span><span class=n>method_name</span><span class=o>]</span>
              <span class=k>if</span> <span class=nb>method</span><span class=p>(</span><span class=n>method_name</span><span class=p>)</span><span class=o>.</span><span class=n>arity</span> <span class=o>==</span> <span class=mi>1</span>
                <span class=c1># for plugin compatibility</span>
                <span class=n>args</span> <span class=o>&lt;&lt;</span> <span class=n>runner</span><span class=o>.</span><span class=n>options</span>
              <span class=k>end</span>

              <span class=n>public_send</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
            <span class=k>end</span>

            <span class=k>if</span> <span class=n>different?</span>
              <span class=n>updated!</span>
              <span class=n>runner</span><span class=o>.</span><span class=n>handler</span><span class=o>.</span><span class=n>event</span><span class=p>(</span><span class=ss>:attribute_changed</span><span class=p>,</span> <span class=ss>from</span><span class=p>:</span> <span class=vi>@current_attributes</span><span class=p>,</span> <span class=ss>to</span><span class=p>:</span> <span class=vi>@attributes</span><span class=p>)</span>
            <span class=k>end</span>
          <span class=k>end</span>

          <span class=vi>@current_action</span> <span class=o>=</span> <span class=kp>nil</span>
          <span class=vi>@attributes</span> <span class=o>=</span> <span class=n>original_attributes</span>
        <span class=k>end</span>
      <span class=k>end</span>
</code></pre></div><p><code>method_name = "action_#{action}"</code> というメソッドを実装してアクションを追加できる．<code>#pre_action</code>, <code>#set_current_attributes</code> などサブクラスで使えるフックが用意されている．
コマンドの発行は，サブクラスにて <code>#run_command</code> を使う．</p><h1 id=http_request-リソース>http_request リソース</h1><p>上記を踏まえて，lib/resources/http_request.rb を読んだら，単純に HTTP request を送るもので，HTTP でファイルを取ってくる感じではなかった．<code>file</code> リソースにもそんな感じの機能はなかったので，<code>execute</code> リソースでやってくださいということだと理解した．</p><br><p class=back-to-posts><a href=https://itkq.jp/blog/>Back to posts</a></p></div><br><div class=disqus><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"itkq-jp"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-71205730-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js></script><script type=text/javascript>hljs.initHighlightingOnLoad();</script></body></html>